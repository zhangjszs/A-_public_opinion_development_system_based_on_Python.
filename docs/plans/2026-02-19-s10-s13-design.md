# 整改清单 S10-S13 设计文档

更新时间：2026-02-19
范围：后端 `src/`、前端 `frontend/src/`、配置与文档

---

## S10 — 统一数据访问层

### 问题

`src/utils/query.py` 中并存三套连接机制：

1. 自定义 `DatabasePool`（pymysql 手动连接池）
2. SQLAlchemy 引擎（用于 pandas）
3. 全局备用连接 `_backup_connection`（懒加载 pymysql）

三套机制独立运行，连接数无法协调，维护复杂度高。

### 方案（选定：方案 A）

保留 SQLAlchemy，删除其余两套：

1. 删除 `DatabasePool` 类及其所有方法
2. 删除全局变量 `_backup_connection`、`conn`、`cursor`
3. 对外只暴露 `engine`（SQLAlchemy Engine）和 `db_session`（scoped_session）
4. pandas `read_sql` 调用改为 `pd.read_sql(sql, engine)`
5. 扫描并替换所有 `get_connection()`、`conn`、`cursor` 调用点

### 涉及文件

- `src/utils/query.py`（主要改动）
- `src/views/data/data_api.py`
- `src/services/*.py`（扫描直接用 pymysql 的地方）

### 完成标准

- `query.py` 中无 `DatabasePool`、无 `_backup_connection`
- 全项目无 `import pymysql` 的直接连接调用（repositories 除外如有必要）
- 现有测试通过，DB 连接数监控正常

---

## S11 — 统一任务状态 API 契约

### 问题

前后端任务状态字段不一致：

| 字段 | 后端实际返回 | 前端期望 |
|------|------------|---------|
| 状态 | `state` | `status` |
| 进度 | `progress`（仅 PROGRESS 时） | `progress` |
| 消息 | 无 | `message` |
| 结果 | `result`（仅 SUCCESS 时） | - |

### 方案

统一后端返回结构（所有状态下字段一致）：

```json
{
  "task_id": "string",
  "state": "PENDING|PROGRESS|SUCCESS|FAILURE",
  "progress": 0,
  "message": "string",
  "result": {}
}
```

改动：

1. `src/tasks/celery_spider.py`：`update_state` 的 meta 统一包含 `message` 和 `progress`（0-100 整数）
2. `src/views/api/api.py`：任务状态接口不再按 state 分支返回不同字段，统一映射为上述结构
3. `frontend/src/views/system/tasks.vue`：对齐新字段名，移除对不存在字段的引用

### 涉及文件

- `src/tasks/celery_spider.py`
- `src/views/api/api.py`
- `frontend/src/views/system/tasks.vue`

### 完成标准

- 后端所有任务状态下均返回完整五字段结构
- 前端任务列表页正常显示进度和消息，无 undefined
- API schema 手工验证通过

---

## S12 — 命名与异常处理规范化

### 问题

- 15+ 处裸 `except:`（ruff E722），无日志，错误被静默吞掉
- 模型字段驼峰混用（`createTime`、`likeNum`、`commentsLen`）
- 大量格式问题（尾部空格、导入排序等）

### 方案

分两步：

**步骤 1 — 自动修复格式问题**

```bash
ruff check src/ --fix --select W291,W293,I001,UP009
```

**步骤 2 — 手动修复裸 except**

将所有 `except:` 改为 `except Exception as e:`，并在 except 块内补充：

```python
logger.error("描述性消息: %s", e, exc_info=True)
```

重点文件：`src/app.py`、`src/utils/query.py`、`src/tasks/celery_spider.py`、`src/views/api/api.py`

**步骤 3 — 模型命名**

`src/models/user.py` 中 `createTime` 改为 `create_time`，同步更新所有引用点。其余模型字段命名问题记录到技术债，不在本次范围内（避免改动面过大）。

### 涉及文件

- `src/app.py`
- `src/utils/query.py`
- `src/tasks/celery_spider.py`
- `src/views/api/api.py`
- `src/models/user.py`（及引用点）

### 完成标准

- `ruff check src/ --select E722` 输出为零
- `src/models/user.py` 字段全部 snake_case
- 格式类 ruff 错误数量显著下降

---

## S13 — 文档与目录治理

### 问题

- `.env.example` 缺少部分配置项
- `ARCHITECTURE.md` 数据访问层描述与 S10 完成后的实现不符
- `tests/test_security_hardening.py` 未被 git 追踪，游离在测试体系外

### 方案

1. `.env.example`：对照 `src/config/settings.py` 补全所有必需配置项，加注释说明每项用途
2. `ARCHITECTURE.md`：更新数据访问层章节，描述单一 SQLAlchemy 架构
3. `tests/`：将 `test_security_hardening.py` 纳入 git 追踪；为 S10/S11 补充基本测试用例

### 涉及文件

- `.env.example`
- `ARCHITECTURE.md`
- `tests/test_security_hardening.py`
- `tests/test_s10_db.py`（新增）
- `tests/test_s11_task_api.py`（新增）

### 完成标准

- 按 `.env.example` 配置可成功启动系统
- `ARCHITECTURE.md` 与实现一致
- `pytest tests/` 全部通过，无游离测试文件

---

## 执行顺序

S10 → S11 → S12 → S13，单步推进，每步完成后验证再进入下一步。
