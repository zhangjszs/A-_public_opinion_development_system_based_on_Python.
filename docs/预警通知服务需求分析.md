# 预警通知服务需求分析文档

## 一、需求概述

### 1.1 项目背景
预警通知服务是舆情监测系统的关键组件，负责在检测到异常舆情时及时通知相关人员，确保预警信息能够快速传达。

### 1.2 项目目标
- 支持邮件和短信两种通知方式
- 实现通知模板管理
- 支持多接收人配置
- 提供发送状态跟踪
- 实现失败重试机制

---

## 二、功能需求

### 2.1 触发条件

| 触发场景 | 触发条件 | 通知级别 |
|---------|---------|---------|
| 负面舆情激增 | 负面评论数超过阈值 | 紧急 |
| 情感突变 | 情感分数变化超过阈值 | 高 |
| 热点话题 | 话题热度超过阈值 | 中 |
| 敏感词匹配 | 检测到敏感关键词 | 紧急 |
| 讨论量异常 | 讨论量增长率超过阈值 | 高 |

### 2.2 内容模板

#### 邮件模板格式
```
主题：【舆情预警】{预警类型} - {预警级别}

正文：
尊敬的用户：

您好！系统检测到以下舆情预警：

预警类型：{预警类型}
预警级别：{预警级别}
触发时间：{触发时间}
预警内容：{预警内容}

相关数据：
- 涉及话题：{话题名称}
- 负面评论数：{负面评论数}
- 情感指数：{情感指数}
- 传播范围：{传播范围}

建议措施：
{建议措施}

请及时关注并处理。

此致
舆情监测系统
{系统时间}
```

#### 短信模板格式
```
【舆情预警】{预警类型}：{预警摘要}。详情请登录系统查看。退订回T。
```

### 2.3 接收对象配置规则

| 配置项 | 说明 |
|-------|------|
| 用户ID | 关联系统用户 |
| 邮箱地址 | 接收邮件通知 |
| 手机号码 | 接收短信通知 |
| 通知级别 | 设置接收的最低预警级别 |
| 通知渠道 | 邮件/短信/全部 |
| 通知时段 | 允许接收通知的时间段 |
| 启用状态 | 是否启用通知 |

---

## 三、系统架构设计

### 3.1 架构概览

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   预警规则引擎   │────▶│   通知队列服务   │────▶│   通知发送服务   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                        │
                        ┌───────────────────────────────┼───────────────────────────────┐
                        ▼                               ▼                               ▼
                ┌───────────────┐               ┌───────────────┐               ┌───────────────┐
                │   邮件服务    │               │   短信服务    │               │  WebSocket    │
                │   (SMTP)      │               │  (阿里云SMS)  │               │   推送服务    │
                └───────────────┘               └───────────────┘               └───────────────┘
```

### 3.2 消息队列选型

考虑到项目规模和部署复杂度，采用 **内存队列 + 持久化** 方案：

- **主队列**：内存队列（deque），高性能
- **持久化**：SQLite/MySQL，防止消息丢失
- **重试队列**：单独管理失败消息

### 3.3 第三方服务接口

#### 邮件服务 (SMTP)
- 支持标准 SMTP 协议
- 支持 SSL/TLS 加密
- 支持附件发送

#### 短信服务 (阿里云SMS)
- 使用阿里云短信服务 API
- 支持模板短信
- 支持批量发送

---

## 四、数据库设计

### 4.1 通知记录表 (notification_log)

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | VARCHAR(36) | 主键UUID |
| alert_id | VARCHAR(36) | 关联预警ID |
| user_id | INT | 接收用户ID |
| channel | ENUM | 通知渠道(email/sms/websocket) |
| subject | VARCHAR(255) | 通知主题 |
| content | TEXT | 通知内容 |
| status | ENUM | 发送状态(pending/sent/failed) |
| retry_count | INT | 重试次数 |
| error_message | TEXT | 错误信息 |
| sent_at | DATETIME | 发送时间 |
| created_at | DATETIME | 创建时间 |

### 4.2 通知接收人表 (notification_recipient)

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | INT | 主键自增 |
| user_id | INT | 关联用户ID |
| email | VARCHAR(100) | 邮箱地址 |
| phone | VARCHAR(20) | 手机号码 |
| min_level | ENUM | 最低通知级别 |
| channels | JSON | 通知渠道配置 |
| quiet_hours | JSON | 免打扰时段 |
| enabled | BOOLEAN | 是否启用 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 4.3 通知模板表 (notification_template)

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | INT | 主键自增 |
| name | VARCHAR(100) | 模板名称 |
| alert_type | VARCHAR(50) | 预警类型 |
| channel | ENUM | 通知渠道 |
| subject_template | VARCHAR(255) | 主题模板 |
| content_template | TEXT | 内容模板 |
| sms_template | VARCHAR(500) | 短信模板 |
| enabled | BOOLEAN | 是否启用 |
| created_at | DATETIME | 创建时间 |

---

## 五、核心功能模块

### 5.1 通知生成器 (NotificationGenerator)
- 根据预警信息生成通知内容
- 应用模板渲染
- 选择接收人

### 5.2 通知发送器 (NotificationSender)
- 邮件发送服务
- 短信发送服务
- WebSocket 推送服务

### 5.3 状态跟踪器 (NotificationTracker)
- 记录发送状态
- 更新发送结果
- 统计发送成功率

### 5.4 重试机制 (RetryHandler)
- 失败消息重试
- 指数退避策略
- 最大重试次数限制

---

## 六、非功能需求

### 6.1 性能要求
- 单次通知发送延迟 < 3秒
- 支持并发发送 100 条/秒
- 队列容量支持 10000 条消息

### 6.2 可靠性要求
- 消息不丢失（持久化）
- 发送成功率 > 99%
- 失败自动重试

### 6.3 安全要求
- 敏感信息加密存储
- SMTP 密码加密
- 短信签名验证

---

*文档版本：v1.0*
*创建日期：2026-02-21*
