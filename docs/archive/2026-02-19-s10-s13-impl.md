# S10-S13 整改实施计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 完成整改清单 S10-S13：统一数据访问层、统一任务状态 API 契约、规范命名与异常处理、治理文档与目录。

**Architecture:** 保留 SQLAlchemy 作为唯一数据库访问层，删除自定义 pymysql 连接池；统一 Celery 任务状态返回结构；消除裸 except；补全文档。

**Tech Stack:** Python/Flask, SQLAlchemy, Celery, Vue 3, ruff

---

## Task 1: S10 — 重写 query.py，删除 DatabasePool 和备用连接

**Files:**
- Modify: `src/utils/query.py`（全文替换）

**背景：**
当前 `query.py` 有三套连接机制：`DatabasePool`（pymysql）、SQLAlchemy engine、备用连接。
目标：只保留 SQLAlchemy engine + scoped_session，同时保留 `querys()` 和 `query_dataframe()` 函数签名（调用方不需要改动）。

**Step 1: 写测试（先确认现有行为）**

新建 `tests/test_s10_db.py`：

```python
"""S10: 验证统一后的数据访问层"""
import pytest
from unittest.mock import patch, MagicMock


def test_query_dataframe_uses_engine():
    """query_dataframe 应使用 SQLAlchemy engine，不依赖 pymysql"""
    import importlib
    import sys
    # 确保没有 DatabasePool 类
    import utils.query as q
    assert not hasattr(q, 'DatabasePool'), "DatabasePool 应已删除"
    assert not hasattr(q, 'db_pool'), "db_pool 应已删除"
    assert not hasattr(q, '_backup_connection'), "_backup_connection 应已删除"
    assert hasattr(q, 'engine'), "engine 应存在"
    assert hasattr(q, 'db_session'), "db_session 应存在"


def test_querys_function_exists():
    """querys() 函数签名保持不变"""
    from utils.query import querys
    import inspect
    sig = inspect.signature(querys)
    params = list(sig.parameters.keys())
    assert 'sql' in params
    assert 'params' in params
```

**Step 2: 运行测试，确认失败**

```bash
cd D:/coding/Pycharm/基于python微博舆情分析可视化系统
python -m pytest tests/test_s10_db.py -v 2>&1 | head -30
```

预期：`test_query_dataframe_uses_engine` FAIL（因为 DatabasePool 还存在）

**Step 3: 重写 query.py**

用以下内容完整替换 `src/utils/query.py`（保留 `querys` 和 `query_dataframe` 签名，内部改用 SQLAlchemy）：

```python
"""
数据库访问模块
唯一数据访问层：SQLAlchemy engine + scoped_session
"""
from __future__ import annotations

import logging
import time
from typing import Any

import pandas as pd
from sqlalchemy import create_engine, text
from sqlalchemy.orm import scoped_session, sessionmaker

from config.settings import Config

logger = logging.getLogger(__name__)

# ── 唯一连接池：SQLAlchemy engine ──────────────────────────────────────────
engine = create_engine(
    Config.get_database_url(),
    pool_size=Config.DB_POOL_SIZE,
    max_overflow=20,
    pool_recycle=Config.DB_POOL_RECYCLE,
    pool_pre_ping=True,
    pool_timeout=Config.DB_POOL_TIMEOUT,
    echo=Config.IS_DEVELOPMENT,
)

db_session = scoped_session(sessionmaker(bind=engine))


# ── 兼容旧调用的查询函数 ───────────────────────────────────────────────────

def querys(sql: str, params: list | None = None, type: str = "no_select") -> Any:
    """
    执行 SQL 语句，兼容旧调用签名。

    Args:
        sql: SQL 语句（支持 %s 占位符）
        params: 参数列表
        type: 'no_select' 表示写操作，其他值表示 SELECT

    Returns:
        SELECT 返回字典列表；写操作返回 '数据库语句执行成功'
    """
    if params is None:
        params = []

    start = time.time()
    # pymysql 风格 %s 占位符转为 SQLAlchemy :param 风格
    # 简单替换：将位置参数转为命名参数
    named_params = {f"p{i}": v for i, v in enumerate(params)}
    named_sql = sql
    for i in range(len(params)):
        named_sql = named_sql.replace("%s", f":p{i}", 1)

    with engine.connect() as conn:
        result = conn.execute(text(named_sql), named_params)
        if type != "no_select":
            rows = [dict(row._mapping) for row in result]
            logger.debug("查询完成: %d 条记录, 耗时 %.3fs", len(rows), time.time() - start)
            return rows
        else:
            conn.commit()
            logger.debug("写操作完成: 影响 %d 行, 耗时 %.3fs", result.rowcount, time.time() - start)
            return "数据库语句执行成功"


def query_dataframe(sql: str, params: list | None = None) -> pd.DataFrame:
    """
    执行查询并返回 pandas DataFrame。

    Args:
        sql: SQL 语句
        params: 参数列表

    Returns:
        DataFrame，失败时返回空 DataFrame
    """
    start = time.time()
    try:
        if params:
            named_params = {f"p{i}": v for i, v in enumerate(params)}
            named_sql = sql
            for i in range(len(params)):
                named_sql = named_sql.replace("%s", f":p{i}", 1)
            df = pd.read_sql(text(named_sql), engine, params=named_params)
        else:
            df = pd.read_sql(sql, engine)
        logger.debug("DataFrame 查询完成: %d 行, 耗时 %.3fs", len(df), time.time() - start)
        return df
    except Exception as e:
        logger.error("DataFrame 查询错误: %s", e, exc_info=True)
        return pd.DataFrame()


def get_database_stats() -> dict:
    """返回连接池状态（兼容旧调用）"""
    pool = engine.pool
    return {
        "pool_size": pool.size(),
        "checked_in": pool.checkedin(),
        "checked_out": pool.checkedout(),
        "overflow": pool.overflow(),
    }
```

**Step 4: 修复 celery_spider.py 中对 db_pool 的直接引用**

`src/tasks/celery_spider.py` 第 30、42、54 行用了 `db_pool.get_connection()` / `db_pool.return_connection()`，需改为 SQLAlchemy session。

找到该段代码（约第 28-56 行），将：
```python
from utils.query import db_pool
...
conn = db_pool.get_connection()
...
db_pool.return_connection(conn)
```
改为：
```python
from utils.query import engine
from sqlalchemy import text as sa_text
...
with engine.connect() as conn:
    # 原有逻辑放入 with 块
```

（具体改法见 Task 1 Step 5）

**Step 5: 运行测试，确认通过**

```bash
python -m pytest tests/test_s10_db.py -v
```

预期：2 个测试全部 PASS

**Step 6: 运行现有测试套件，确认无回归**

```bash
python -m pytest tests/ -v --ignore=tests/test_s10_db.py -x 2>&1 | tail -20
```

**Step 7: Commit**

```bash
git add src/utils/query.py src/tasks/celery_spider.py tests/test_s10_db.py
git commit -m "refactor(S10): 统一数据访问层，删除 DatabasePool 和备用连接"
```

---

## Task 2: S11 — 统一任务状态 API 返回结构

**Files:**
- Modify: `src/tasks/celery_spider.py:421-449`（`get_task_progress` 函数）
- Modify: `frontend/src/views/system/tasks.vue:89-94`（taskResult 展示）

**背景：**
`get_task_progress` 按 state 分支返回不同字段，前端期望固定的 `{task_id, state, progress, message, result}` 五字段结构。

**Step 1: 写测试**

新建 `tests/test_s11_task_api.py`：

```python
"""S11: 验证任务状态 API 返回统一结构"""
from unittest.mock import MagicMock, patch


def _make_mock_result(state, info=None, result=None):
    r = MagicMock()
    r.state = state
    r.info = info
    r.result = result
    return r


def _call_get_task_progress(mock_result):
    """直接调用 get_task_progress 的核心逻辑（不走 Celery）"""
    from tasks.celery_spider import _build_task_response
    return _build_task_response(mock_result, "test-id-123")


def test_pending_has_all_fields():
    r = _make_mock_result("PENDING")
    resp = _call_get_task_progress(r)
    assert set(resp.keys()) >= {"task_id", "state", "progress", "message", "result"}
    assert resp["state"] == "PENDING"
    assert resp["progress"] == 0


def test_progress_has_all_fields():
    r = _make_mock_result("PROGRESS", info={"current": 3, "total": 10, "status": "爬取中"})
    resp = _call_get_task_progress(r)
    assert resp["state"] == "PROGRESS"
    assert resp["progress"] == 30
    assert "爬取中" in resp["message"]


def test_success_has_all_fields():
    r = _make_mock_result("SUCCESS", result={"crawled": 50})
    resp = _call_get_task_progress(r)
    assert resp["state"] == "SUCCESS"
    assert resp["progress"] == 100
    assert resp["result"] == {"crawled": 50}


def test_failure_has_all_fields():
    r = _make_mock_result("FAILURE", info=Exception("连接超时"))
    resp = _call_get_task_progress(r)
    assert resp["state"] == "FAILURE"
    assert "连接超时" in resp["message"]
```

**Step 2: 运行测试，确认失败**

```bash
python -m pytest tests/test_s11_task_api.py -v 2>&1 | head -20
```

预期：ImportError（`_build_task_response` 不存在）

**Step 3: 在 celery_spider.py 中提取 `_build_task_response` 并修改 `get_task_progress`**

在 `src/tasks/celery_spider.py` 的 `get_task_progress` 函数（第 420-449 行）前插入辅助函数，并重写 `get_task_progress`：

```python
def _build_task_response(result, task_id: str) -> dict:
    """将 Celery AsyncResult 映射为统一的五字段结构"""
    state = result.state
    response = {
        "task_id": task_id,
        "state": state,
        "progress": 0,
        "message": "",
        "result": {},
    }
    if state == "PENDING":
        response["message"] = "任务等待中..."
    elif state == "PROGRESS":
        info = result.info or {}
        current = info.get("current", 0)
        total = info.get("total", 1) or 1
        response["progress"] = int(current / total * 100)
        response["message"] = info.get("status", "")
    elif state == "SUCCESS":
        response["progress"] = 100
        response["result"] = result.result or {}
        response["message"] = "任务完成"
    elif state == "FAILURE":
        response["message"] = str(result.info)
    return response


@celery_app.task(bind=True)
def get_task_progress(self, task_id: str) -> dict:
    from celery.result import AsyncResult
    result = AsyncResult(task_id, app=celery_app)
    return _build_task_response(result, task_id)
```

**Step 4: 修改前端 tasks.vue 展示字段**

`frontend/src/views/system/tasks.vue` 第 91-93 行，将：
```html
<el-descriptions-item label="状态">{{ taskResult.status || '-' }}</el-descriptions-item>
<el-descriptions-item label="进度">{{ taskResult.progress ?? '-' }}</el-descriptions-item>
<el-descriptions-item label="消息" :span="2">{{ taskResult.message || '-' }}</el-descriptions-item>
```
改为：
```html
<el-descriptions-item label="状态">{{ taskResult.state || '-' }}</el-descriptions-item>
<el-descriptions-item label="进度">{{ taskResult.progress != null ? taskResult.progress + '%' : '-' }}</el-descriptions-item>
<el-descriptions-item label="消息" :span="2">{{ taskResult.message || '-' }}</el-descriptions-item>
```

**Step 5: 运行测试，确认通过**

```bash
python -m pytest tests/test_s11_task_api.py -v
```

预期：4 个测试全部 PASS

**Step 6: Commit**

```bash
git add src/tasks/celery_spider.py frontend/src/views/system/tasks.vue tests/test_s11_task_api.py
git commit -m "fix(S11): 统一任务状态 API 返回结构，前后端字段对齐"
```

---

## Task 3: S12-A — 自动修复格式问题

**Files:**
- Modify: `src/` 下多个文件（ruff 自动修复）

**Step 1: 查看当前格式错误数量**

```bash
cd D:/coding/Pycharm/基于python微博舆情分析可视化系统
python -m ruff check src/ --select W291,W293,I001,UP009 --statistics 2>&1 | tail -10
```

**Step 2: 自动修复**

```bash
python -m ruff check src/ --fix --select W291,W293,I001,UP009
```

**Step 3: 确认修复结果**

```bash
python -m ruff check src/ --select W291,W293,I001,UP009 --statistics 2>&1 | tail -5
```

预期：0 个错误

**Step 4: 运行测试，确认无回归**

```bash
python -m pytest tests/ -x -q 2>&1 | tail -10
```

**Step 5: Commit**

```bash
git add src/
git commit -m "style(S12): ruff 自动修复格式问题（尾部空格、导入排序、编码声明）"
```

---

## Task 4: S12-B — 手动修复裸 except

**Files:**
- Modify: `src/app.py:487`
- Modify: `src/utils/query.py:177,181,218,225,369`（重写后已无裸 except，跳过）
- Modify: `src/tasks/celery_spider.py:363`
- Modify: `src/views/api/api.py:349`

**注意：** Task 1 重写了 `query.py`，其中的裸 except 已消除。只需处理其余 3 处。

**Step 1: 修复 src/app.py:487**

将：
```python
    except:
        # 如果模板加载失败，返回纯文本
        return '服务器内部错误，请稍后重试', 500
```
改为：
```python
    except Exception as e:
        logger.error("模板加载失败，返回纯文本: %s", e)
        return '服务器内部错误，请稍后重试', 500
```

**Step 2: 修复 src/tasks/celery_spider.py:363**

将：
```python
                            except:
                                pass
```
改为：
```python
                            except Exception as e:
                                logger.debug("解析 detail_url 失败: %s", e)
```

**Step 3: 修复 src/views/api/api.py:349**

将：
```python
            except:
                pass
```
改为：
```python
            except Exception as e:
                logger.debug("读取训练摘要文件失败: %s", e)
```

**Step 4: 验证 E722 清零**

```bash
python -m ruff check src/ --select E722
```

预期：无输出（0 个错误）

**Step 5: Commit**

```bash
git add src/app.py src/tasks/celery_spider.py src/views/api/api.py
git commit -m "fix(S12): 消除所有裸 except，补充错误日志"
```

---

## Task 5: S12-C — 修复 User 模型命名

**Files:**
- Modify: `src/models/user.py`
- Modify: `src/repositories/user_repository.py:16,21`
- Modify: `src/services/auth_service.py:35`
- Modify: `src/views/api/api.py:89,99`
- Modify: `src/views/user/user.py:73,166,178`

**背景：** `User.createTime` 是驼峰命名，需改为 `create_time`。共 10 处引用。

**Step 1: 修改 src/models/user.py**

将：
```python
    createTime = Column(DateTime, default=datetime.datetime.utcnow)

    def __init__(self, username=None, password=None, createTime=None):
        self.username = username
        self.password = password
        self.createTime = createTime
```
改为：
```python
    create_time = Column(DateTime, default=datetime.datetime.utcnow)

    def __init__(self, username=None, password=None, create_time=None):
        self.username = username
        self.password = password
        self.create_time = create_time
```

**Step 2: 修改 src/repositories/user_repository.py**

第 16 行：`'createTime': user.createTime` → `'create_time': user.create_time`
第 21 行：`User(username=username, password=password_hash, createTime=create_time)` → `User(username=username, password=password_hash, create_time=create_time)`

**Step 3: 修改 src/services/auth_service.py:35**

`'createTime': str(user.get('createTime', ''))` → `'create_time': str(user.get('create_time', ''))`

**Step 4: 修改 src/views/api/api.py**

第 89 行 SQL：`SELECT id, username, createTime FROM user` → `SELECT id, username, create_time FROM user`
第 99 行：`'createTime': str(info.get('createTime', ''))` → `'create_time': str(info.get('create_time', ''))`

**Step 5: 修改 src/views/user/user.py**

第 73 行：`session['createTime'] = user_info['createTime']` → `session['create_time'] = user_info['create_time']`
第 166 行 SQL：`SELECT id, username, createTime FROM user` → `SELECT id, username, create_time FROM user`
第 178 行：`'createTime': str(user_info.get('createTime', ''))` → `'create_time': str(user_info.get('create_time', ''))`

**Step 6: 运行测试**

```bash
python -m pytest tests/ -x -q 2>&1 | tail -10
```

**Step 7: Commit**

```bash
git add src/models/user.py src/repositories/user_repository.py src/services/auth_service.py src/views/api/api.py src/views/user/user.py
git commit -m "refactor(S12): User.createTime 重命名为 create_time，统一 snake_case"
```

---

## Task 6: S13 — 文档与目录治理

**Files:**
- Modify: `.env.example`
- Modify: `ARCHITECTURE.md`
- Add to git: `tests/test_security_hardening.py`

**Step 1: 对照 settings.py 补全 .env.example**

```bash
grep -n "os.environ\|Config\." D:/coding/Pycharm/基于python微博舆情分析可视化系统/src/config/settings.py | head -40
```

确认 `.env.example` 包含所有必需配置项，每项加注释说明。

**Step 2: 更新 ARCHITECTURE.md 数据访问层章节**

找到描述数据库连接的章节，将"三套连接机制"的描述更新为：

> 数据访问层统一使用 SQLAlchemy（`src/utils/query.py`）。`engine`（连接池）和 `db_session`（scoped_session）是唯一的数据库访问入口。`querys()` 和 `query_dataframe()` 提供向后兼容的函数接口。

**Step 3: 将 test_security_hardening.py 纳入 git 追踪**

```bash
cd D:/coding/Pycharm/基于python微博舆情分析可视化系统
git add tests/test_security_hardening.py
```

**Step 4: 运行完整测试套件**

```bash
python -m pytest tests/ -v 2>&1 | tail -20
```

预期：全部通过，无游离测试文件

**Step 5: Commit**

```bash
git add .env.example ARCHITECTURE.md tests/test_security_hardening.py
git commit -m "docs(S13): 补全 .env.example，更新架构文档，纳入安全测试文件"
```

---

## 执行顺序总结

| Task | 对应整改项 | 关键验证 |
|------|-----------|---------|
| 1 | S10 统一数据访问层 | `test_s10_db.py` PASS，无 DatabasePool |
| 2 | S11 任务状态 API | `test_s11_task_api.py` PASS，前端字段对齐 |
| 3 | S12-A 格式修复 | ruff W291/I001 清零 |
| 4 | S12-B 裸 except | ruff E722 清零 |
| 5 | S12-C 命名规范 | 全量测试通过 |
| 6 | S13 文档治理 | 全量测试通过，文档更新 |
