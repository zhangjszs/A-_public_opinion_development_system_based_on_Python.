# 微博舆情分析系统：可执行整改清单（v1）

更新时间：2026-02-25
适用范围：后端 `src/`、前端 `frontend/src/`、配置与文档

## 1. 执行规则（先统一）

1. 按优先级执行：`P0 -> P1 -> P2 -> P3`，不跳级。  
2. 一次只做一个任务项（单步可回滚）。  
3. 每步都必须包含：代码变更、验证命令、结果记录。  
4. 每步完成后再进入下一步，避免并发改动导致回归难定位。  

---

## 2. 任务清单（按执行顺序）

> 状态说明：`[ ] 未开始` `[-] 进行中` `[x] 已完成`

| ID | 优先级 | 状态 | 任务 | 关键位置 | 完成标准（DoD） | 验证方式 |
|---|---|---|---|---|---|---|
| S01 | P0 | [x] | 修复管理员鉴权“默认放行” | `src/utils/authz.py` `src/views/api/api.py` `src/views/data/data_api.py` `src/config/settings.py` | `ADMIN_USERS` 为空时管理接口默认拒绝；生产启动校验管理员配置 | 管理接口鉴权测试 + 手工调用返回 `403` |
| S02 | P1 | [x] | 收紧异步任务权限边界 | `src/views/api/api.py` `src/views/api/spider_api.py` | 爬虫触发/任务状态接口具备管理员或属主校验 | API 集成测试（普通用户不可调用） |
| S03 | P1 | [x] | CSRF 策略纠偏 | `src/app.py` `src/views/user/user.py` | 仅 API Token 场景免 CSRF；session/form 写操作开启 CSRF | 登录/注册/登出回归 + CSRF 负测 |
| S04 | P1 | [x] | 去除高风险反序列化 | `src/utils/cache.py` `src/utils/deduplicator.py` | 移除 `pickle.load`；改 JSON/安全格式；旧缓存兼容迁移 | 单测 + 恶意文件注入负测 |
| S05 | P1 | [x] | 消除 `eval` 执行风险 | `src/model/hyperparameter_optimizer.py` | `eval` 改为 `ast.literal_eval` 或白名单映射 | 训练参数解析单测 |
| S06 | P1 | [x] | 统一 Celery/Redis/LLM 配置契约 | `src/config/settings.py` `src/tasks/celery_config.py` `src/services/sentiment_service.py` `src/tasks/celery_sentiment.py` | 配置项完整、命名一致、启动即校验 | 启动检查 + Celery 冒烟 |
| S07 | P1 | [x] | 收敛爬虫入口为单一编排 | `src/views/api/api.py` `src/views/api/spider_api.py` `src/tasks/celery_spider.py` | 移除重复同步入口；统一通过 Celery 提交与查询 | 爬虫流程端到端验证 |
| S08 | P1 | [x] | 把同步重任务改为异步+批量写入 | `src/views/api/api.py` `src/tasks/celery_spider.py` | 请求不再阻塞；DB 从逐条写改批量写 | 压测对比（RT、吞吐） |
| S09 | P1 | [x] | 评论情感计算改预计算/缓存 | `src/views/data/data_api.py` `src/services/sentiment_service.py` | 接口不再逐请求循环 `SnowNLP`；命中缓存/聚合结果 | 接口耗时基准对比 |
| S10 | P2 | [x] | 统一数据访问层（去双池/去旁路 SQL） | `src/utils/query.py` `src/repositories/*` `src/services/*` | 明确单一数据访问路径；连接池策略统一 | DB 连接数/错误率监控 |
| S11 | P2 | [x] | 统一任务状态 API 契约 | `src/tasks/celery_spider.py` `src/views/api/api.py` `frontend/src/views/system/tasks.vue` | 前后端字段一致（如 `state/progress/message/result`） | 前端页面回归 + API schema 校验 |
| S12 | P2 | [x] | 命名与异常处理规范化 | `src/models/user.py` `src/repositories/user_repository.py` 等 | 命名统一；减少裸 `except`；错误日志可追踪 | `ruff` 关键规则清零 |
| S13 | P3 | [x] | 文档与目录治理 | `.env.example` `README.md` `ARCHITECTURE.md` `tests/` | 补全必需配置文档；架构文档与实现一致；测试目录职责清晰 | 文档审阅 + 新人按文档启动成功 |

---

## 3. 建议迭代节奏

- **迭代 1（安全封口）**：S01-S05  
- **迭代 2（性能与架构主路径）**：S06-S09  
- **迭代 3（治理与收尾）**：S10-S13  

---

## 4. 单步执行模板（每次都按这个输出）

### `Sxx` 执行记录

- **变更目标**：  
- **改动文件**：  
- **核心改动**：  
- **验证命令**：  
- **验证结果**：  
- **风险与回滚点**：  
- **是否进入下一步**：是 / 否  

---

## 5. 完成状态

**全部 13 项整改已完成（S01-S13）。**

- 迭代 1（安全封口）：S01-S05 ✅
- 迭代 2（性能与架构主路径）：S06-S09 ✅
- 迭代 3（治理与收尾）：S10-S13 ✅

最终测试：72 passed, 2 skipped。ruff E722/W291/I001/UP009 全部清零。

---

## 6. 2026-02-25 补充回归记录（S10-S13）

- **回归目标**：校验后续整改项在当前分支状态下仍满足 DoD，并清理新增规范问题。  
- **改动文件**：`tests/test_alert_service.py`、`tests/test_propagation_service.py`、`tests/test_search_service.py`、`tests/test_sentiment_service.py`。  
- **核心改动**：修复 `ruff` 报告的 `I001/W291`（导入排序、尾随空格），无业务逻辑改动。  
- **验证命令**：`pytest tests/test_s10_db.py tests/test_s11_task_api.py -q`、`pytest tests/test_alert_service.py tests/test_propagation_service.py tests/test_search_service.py tests/test_sentiment_service.py -q`、`ruff check src tests --select E722,W291,I001,UP009`。  
- **验证结果**：上述命令全部通过。  
- **说明**：该记录形成时，`pytest -q` 在 sandbox 中曾受系统临时目录与多进程管道权限影响；问题已在“第 7 节”完成修复。  

---

## 7. 2026-02-25 沙箱兼容性修复（全量测试）

- **修复目标**：消除 sandbox 下全量测试的临时目录权限与并行任务兼容问题。  
- **改动文件**：`tests/conftest.py`、`tests/test_search.py`、`src/model/trainModel.py`、`.gitignore`。  
- **核心改动**：测试进程统一使用项目内可写临时目录；替换 `tempfile.mkdtemp` 目录创建策略；搜索测试改为自管临时目录；模型评估在受限环境自动回退单进程并强制模型内部 `n_jobs=1`。  
- **验证命令**：`pytest tests/test_model_pipeline.py tests/test_sentiment_model.py tests/test_search.py -q`、`pytest -q`、`ruff check src tests --select E722,W291,I001,UP009`。  
- **验证结果**：全部通过（`pytest -q` 全量 100% 通过）。  
